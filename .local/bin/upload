#!/bin/sh -e
# upload - client for uploading files
#
# for 0x0.st and workalikes

usage() { printf 'usage: %s [-cnsuv] [-h HOST] [-p POST_VARIABLE] [FILE/URL ...]\n' "${0##*/}"; }

output() {
    printf '%s\n' "$1"
    [ -n "${clip}" ] && printf '%s' "$1" | xsel -b
    "${notification}" && \
        notification upload -i media-upload "upload" "Uploaded to $1.${clip:+ Copied to clipboard.}"
}


# ${clip} is empty by default so as to make substitution for notification easier.
clip='false'
notification='false'
host='https://0x0.st'
post='file'
has_stdin='false'
mode='upload_file'
[ -t 0 ] || has_stdin='true'
curl_verbose='false'

while getopts :cnsuvh:p: arg >/dev/null 2>&1; do
    case "${arg}" in
        c)  clip="true"         ;;
        n)  notification="true" ;;
        h)  host="${OPTARG}"    ;;
        p)  post="${OPTARG}"    ;;
        s)  mode="shorten_url"  ;;
        u)  mode="upload_url"   ;;
        v)  curl_verbose="true" ;;
        ?)
            printf 'unknown argument -- %s\n' "${OPTARG}"
            usage
            exit 255
            ;;
    esac
done
shift $((OPTIND - 1))

"${clip}" || clip=
"${curl_verbose}" || curl_verbose=
[ $# -eq 0 ] && mode="upload_stdin"

if "${has_stdin}"; then
    url=$(sponge | curl ${curl_verbose:--sS} -F "${post}=<-" "${host}")
    output "${url}"
fi

while [ $# -gt 0 ]; do
    case "${mode}" in
        upload_file)
            url=$(curl ${curl_verbose:--sS} -F "${post}=@${1}" "${host}")
            ;;
        upload_url)
            url=$(curl ${curl_verbose:--sS} -F "url=${1}" "${host}")
            ;;
        shorten_url)
            url=$(curl ${curl_verbose:--sS} -F "shorten=${1}" "${host}")
            ;;
    esac

    output "${url}"
    shift
done

