#!/bin/sh

: "${XDG_RUNTIME_DIR:=/run/user/$(id -un)}"

usage() {
    cat >&2 <<EOF
usage: ${0##*/} [-t] ARCHIVE...
EOF
}

toggle=false
while getopts :t arg >/dev/null 2>&1; do
    case "${arg}" in
        t)
            toggle=true
            ;;
        ?)
            usage
            ;;
    esac
done
shift $(( OPTIND - 1 ))

while [ "$#" -gt 0 ]; do
    dir="${XDG_RUNTIME_DIR}"/mnt/archive/"${1##*/}"

    if [ "${toggle}" = true ] && mountpoint -q "${dir}" >/dev/null 2>&1; then
        if umount "${dir}"; then
            notify-send -u low "mount-archive" "Unmounted '${1}' successfully."
        else
            notify-send -u high "mount-archive" "Failed to unmount '${1}', is it busy?"
            e=2
        fi
    else
        mkdir -p "${dir}"
        if archivemount "${1}" "${dir}"; then
            notify-send -u low "mount-archive" "Mounted '${1}' successfully."
            lunch -- "${dir}"
        else
            notify-send -u high "mount-archive" "Failed to mount '$1', is the archive type supported?"
            e=3
        fi
    fi
    shift
done

[ "$e" -gt 0 ] && exit $?
