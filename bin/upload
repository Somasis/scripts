#!/bin/sh -e
# upload - client for uploading files
#
# for 0x0.st and workalikes

usage() { printf 'usage: %s [-cnsuv] [-h HOST] [-p POST_VARIABLE] [FILE/URL ...]\n' "${0##*/}"; }

# ${clip} is empty by default so as to make substitution for notification easier.
clip='false'
notification='false'
host='https://0x0.st'
post='file'
mode='upload_stdin'
curl_verbose='false'

while getopts :cnsuvh:p: arg >/dev/null 2>&1; do
    case "${arg}" in
        c)  clip="true"         ;;
        n)  notification="true" ;;
        h)  host="${OPTARG}"    ;;
        p)  post="${OPTARG}"    ;;
        s)  mode="shorten_url"  ;;
        u)  mode="upload_url"   ;;
        v)  curl_verbose="true" ;;
        ?)
            printf 'unknown argument -- %s\n' "${OPTARG}"
            usage
            ;;
    esac
done
shift $((OPTIND - 1))

"${clip}" || clip=
"${curl_verbose}" || curl_verbose=
[ $# -gt 0 ] && mode="upload_file"

while [ $# -gt 0 ] || [ "${mode}" = 'upload_stdin' ]; do
    case "${mode}" in
        upload_stdin)
            url=$(sponge | curl ${curl_verbose:--sS} -F "${post}=<-" "${host}")
            ;;
        upload_file)
            url=$(curl ${curl_verbose:--sS} -F "${post}=@${1}" "${host}")
            ;;
        upload_url)
            url=$(curl ${curl_verbose:--sS} -F "url=${1}" "${host}")
            ;;
        shorten_url)
            url=$(curl ${curl_verbose:--sS} -F "shorten=${1}" "${host}")
            ;;
    esac

    printf '%s\n' "${url}"
    [ -n "${clip}" ] && printf '%s' "${url}" | xsel -b
    "${notification}" && \
        notification upload -i media-upload "upload" "Uploaded to ${url}.${clip:+ Copied to clipboard.}"

    case "${mode}" in
        upload_stdin)   break ;;
        *)              shift ;;
    esac
done

