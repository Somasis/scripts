#!/bin/bash
# OldNotifier.sh -- notifier for The Old Reader
# (c) 2014 Somasis <somasissounds@gmail.com> - MIT License

## Don't change these variables, use $XDG_CONFIG_HOME/oldnotifier.conf for your own settings!
email=
password=
notify_for="total"
notify_every="1s"
wait_until_top_of_hour="false"
retrieve_preference='wget'

SCRIPT_DIR=$(cd "$(dirname "$0")"; pwd)

. "$SCRIPT_DIR/common.sh" 2>&1 >/dev/null
. "$XDG_CONFIG_HOME/oldnotifier.conf" 2>&1 >/dev/null

if [[ "$email" != *@* ]];then
    echo "You must supply an email"
    exit 1
fi

if [[ "$wait_until_top_of_hour" == "true" ]];then
    current_epoch=$(date +"%s")
    target_epoch=$(date -d "$(( $(date +%H) + 1 )):00:00" +%s)
    sleep_seconds=$(( $target_epoch - $current_epoch ))
    echo "Waiting until $(date +$(( $(date +%H) + 1 )):00)..."
    sleep "$sleep_seconds"
fi

user_agent="OldNotifer.sh - https://github.com/Somasis/scripts"

post_data="client=OldNotifier.sh&accountType=HOSTED&service=reader&Email=$email&Passwd=$password"
header_data=
key=$(retrieve "https://theoldreader.com/accounts/ClientLogin" | grep "^Auth=" | cut -d'=' -f2)

if [[ -z "$key" ]];then
    echo "Key is invalid, check your password or email configuration"
    exit 2
fi

while true; do
    post_data=
    header_data="Authorization: GoogleLogin auth=$key"
    unread_raw=$(retrieve "https://theoldreader.com/reader/api/0/unread-count?output=json" | sed 's/[0-9],/&,\n/g' | sed 's/","count":/:/g;s/.*id":"//g;s/,,//g;s/.*}]}//;s/{"//g;s/":/:/g' | grep -v '^$')
    if [[ -z "$unread_raw" ]];then
        echo "Failed to get unread count, run this script with bash -x to get debug output"
        exit 3
    fi

    unread_total=$(echo "$unread_raw" | grep "^max:" | cut -d':' -f2)
    unread_feeds=$(echo "$unread_raw" | grep '^feed/' | cut -d'/' -f2)
    unread_labels=$(echo "$unread_raw" | grep 'label/' | cut -d'/' -f4)

    if [[ "$notify_for" == "total" ]];then
        notify-send "The Old Reader" "You have $unread_total unread articles"
    fi
    
    sleep "$notify_every"
done